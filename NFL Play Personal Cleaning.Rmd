---
title: "NFL Play Personal Cleaning"
author: "Josh Garzaniti"
date: "2025-09-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load in packages
```{r}
library(ggplot2)
library(ggdark)
library(caret)
library(tidyverse)
library(tidyr)
library(stringr)
library(xgboost)
library(randomForest)
library(ggrepel)
library(nflreadr)
library(nflplotR)
library(nflfastR)
library(mice)
library(lme4)
library(here)
```

##Load in Data via NFLFastR
```{r}
pbp = nflfastR::load_pbp(2025)
```
Filtering out Special Teams  esque Plays (QB Spike and Kneels)
```{r}
pbp = pbp%>%
  filter(play_type %in% c("pass", "run"))

##Filter out players where there was a timeout or penalty
pbp = pbp%>%
  filter(timeout == 0, penalty == 0, two_point_attempt == 0)

```


Remove all of the variables we don't need:
```{r}
pbp = pbp%>%
  select(-play_id, -game_id, -old_game_id, -week, -game_date, -quarter_seconds_remaining,
         -game_half, -quarter_end, -drive, -sp, -qtr, -time, -yrdln, -qb_kneel, -qb_spike,
         -field_goal_result, -field_goal_attempt, -kick_distance, -away_timeouts_remaining, -timeout, -td_team, -td_player_name, -td_player_id, -total_away_score, -posteam_timeouts_remaining, -defteam_timeouts_remaining, -total_home_score, -posteam_score, -defteam_score, -score_differential, -posteam_score_post, -defteam_score_post)%>%
  select(-score_differential_post, -total_home_epa, -total_away_epa, -total_home_rush_epa, -total_away_rush_epa, -total_home_pass_epa, -total_away_pass_epa, -total_home_comp_air_epa,
         -total_away_comp_air_epa, -total_home_comp_yac_epa, -total_away_comp_yac_epa, -total_home_raw_air_epa, -total_away_raw_air_epa, -total_home_comp_yac_epa, -total_away_comp_yac_epa, -wp, -def_wp, -vegas_wpa, -vegas_home_wpa, -vegas_wp, -vegas_home_wp, -home_wp_post, -away_wp_post, -total_home_rush_wpa, -total_away_rush_wpa, -total_home_comp_air_wpa, -total_away_comp_air_wpa, -total_home_comp_yac_wpa, -total_away_comp_yac_wpa, -total_home_raw_air_wpa, -total_away_raw_air_wpa)%>%
  select(-total_home_raw_yac_wpa, -total_away_raw_yac_wpa, -punt_blocked, -first_down_penalty, -touchback, -punt_inside_twenty, -punt_in_endzone, -punt_out_of_bounds, -punt_downed, -punt_fair_catch, -kickoff_inside_twenty, -kickoff_in_endzone, -kickoff_out_of_bounds, -kickoff_downed, -kickoff_fair_catch, -fumble_not_forced, -penalty, -penalty_team, -fumble_forced, -own_kickoff_recovery, -own_kickoff_recovery_td, -own_kickoff_recovery_player_id, -own_kickoff_recovery_player_name, -return_touchdown, -extra_point_attempt, -two_point_attempt, -kickoff_attempt, -punt_attempt, -lateral_reception, -lateral_rush, -lateral_return, -lateral_recovery, -passer_player_id, -receiver_player_id, -rusher_player_id, -lateral_receiver_player_id, -lateral_receiver_player_name, -lateral_rusher_player_id, -lateral_rusher_player_name, -lateral_rushing_yards, -lateral_sack_player_id, -lateral_sack_player_name)%>%
  select(-lateral_interception_player_id, -lateral_interception_player_name, -interception_player_id, -punt_returner_player_id, -punt_returner_player_name, -lateral_punt_returner_player_id, -lateral_punt_returner_player_name, -lateral_kickoff_returner_player_id, -lateral_kickoff_returner_player_name, -kickoff_returner_player_id, -kicker_player_name, -punter_player_id, -punter_player_name, -kicker_player_id, -kicker_player_name, -blocked_player_id, -blocked_player_name, -tackle_for_loss_1_player_id, -tackle_for_loss_2_player_id, -qb_hit_1_player_id, -qb_hit_2_player_id, -forced_fumble_player_1_player_id, -forced_fumble_player_1_team, -forced_fumble_player_1_player_name, -forced_fumble_player_2_team)%>%
  select(-forced_fumble_player_2_player_id, -forced_fumble_player_2_player_name, -solo_tackle_1_team, -solo_tackle_2_team, -solo_tackle_1_player_id, -solo_tackle_2_player_id, -assist_tackle_1_team, -assist_tackle_2_team, -assist_tackle_3_team, -assist_tackle_4_team, -assist_tackle_1_player_id, -assist_tackle_2_player_id, -assist_tackle_3_player_id, -assist_tackle_4_player_id, -tackle_with_assist, -tackle_with_assist_1_player_id, -tackle_with_assist_2_player_id, -tackle_with_assist_1_team, -tackle_with_assist_2_team, -tackle_with_assist_1_player_name, -tackle_with_assist_2_player_name, -pass_defense_1_player_id, -pass_defense_2_player_id, -fumbled_1_team, -fumbled_1_player_id, -fumbled_1_player_name, -fumbled_2_team, -fumbled_2_player_id, -fumbled_2_player_name, -fumble_recovery_1_player_id)%>%
  select(-fumble_recovery_1_player_name, -fumble_recovery_1_team, -fumble_recovery_1_yards, -fumble_recovery_2_player_id, -fumble_recovery_2_team, -fumble_recovery_2_player_name, -fumble_recovery_2_yards, -sack_player_id, -half_sack_1_player_id, -half_sack_2_player_id, -return_team, -return_yards, -penalty_player_id, -penalty_player_name, -penalty_yards, -penalty_type, -replay_or_challenge, -replay_or_challenge_result, -defensive_two_point_attempt, -defensive_two_point_conv, -defensive_extra_point_attempt, -defensive_extra_point_conv, -safety_player_id, -safety_player_name, -season, -cp, -series, -series_success, -series_result, -order_sequence, -start_time, -time_of_day, -stadium, -weather, -nfl_api_id, -play_clock, -play_deleted, -special_teams_play, -st_play_type, -end_clock_time, -end_yard_line, -fixed_drive, -fixed_drive_result, -drive_real_start_time, -drive_play_count, -drive_time_of_possession, -drive_first_downs, -drive_inside20)%>%
  select(-drive_ended_with_score, -drive_quarter_start, -drive_quarter_end, -drive_yards_penalized, -drive_start_transition, -drive_end_transition, -drive_game_clock_start, -drive_game_clock_end, -drive_start_yard_line, -drive_end_yard_line, -drive_play_id_started, -drive_play_id_ended, -away_score, -home_score, -location, -result, -total, -spread_line, -div_game, -roof, -surface, -temp, -wind, -home_coach, -away_coach, -stadium_id, -game_stadium, -aborted_play, -passer, -passer_jersey_number, -rusher, -rusher_jersey_number, -receiver, -receiver_jersey_number, -special, -play, -passer_id, -rusher_id, -receiver_id, -name, -jersey_number, -id, -fantasy_player_name, -fantasy_player_id, -fantasy, -fantasy_id, -out_of_bounds, -home_opening_kickoff, -extra_point_result)
```

```{r}
passing = pbp%>%
  filter(play_type == "pass")

rushing = pbp%>%
  filter(play_type == "run")
```

Through 2 weeks, teams collectively are passing 58.45% of the time and running
~41.55% of the time.
#Play Rates
```{r}
offense_teams_summary = pbp%>%
  group_by(posteam)%>%
  summarize(total_plays = n())%>%
  arrange(desc(total_plays))

defense_teams_summary = pbp%>%
  group_by(defteam)%>%
  summarize(total_plays = n())%>%
  arrange(desc(total_plays))
```

Through week 2, Cleveland, Buffalo, Carolina, Indianapolis, and San Francisco reflected the top 5 teams with the most offensive plays, while Baltimore, Arizona, Cincinnati, New York (Giants), and Seattle had the most on defense.
##Success Rate
```{r}
team_success_offense = pbp%>%
  group_by(posteam)%>%
  summarize(total_success = sum(success),
         success_per = mean(success))%>%
    rename(team_abbr = posteam)%>%
  arrange(desc(success_per))

team_success_defense = pbp%>%
  group_by(defteam)%>%
  summarize(
    total_stops = sum(success == 0, na.rm = TRUE),
    stop_rate   = mean(success == 0, na.rm = TRUE))%>%
    rename(team_abbr = defteam)%>%
  arrange(desc(stop_rate))
```

Top 5 teams by offensive success rate:
Colts
Jags
Chargers
Bills
49ers

Top 5 teams by defensive success rate:
Broncos
Rams
Chargers
Packers
Lions

Plotting
```{r}
offense_defense_teams = team_success_offense%>%
  inner_join(team_success_defense, by = "team_abbr")

team_success_plot = ggplot(offense_defense_teams, aes(x = success_per, y = stop_rate)) +
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.07) +
  labs(
    title = "NFL Team Success: Offense vs Defense Success Rates",
    subtitle = "2025 Season",
    x = "Offensive Success Rate",
    y = "Defensive Stop Rate")+
  dark_theme_minimal()+
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

team_success_plot
```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/team_success_plot.png",
  plot = team_success_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```


##Success Rate by play style:
```{r}
passing_success = pbp%>%
  filter(play_type == "pass")%>%
  group_by(posteam)%>%
  summarize(total_success = sum(success),
            pass_success_per = mean(success))%>%
    rename(team_abbr = posteam)%>%
  arrange(desc(pass_success_per))

rushing_success = pbp%>%
  filter(play_type == "run")%>%
  group_by(posteam)%>%
  summarize(total_success = sum(success),
            rush_success_per = mean(success))%>%
    rename(team_abbr = posteam)%>%
  arrange(desc(rush_success_per))
```

Who's better at passing (in terms of a per play success rate):
Colts
Chargers
Lions
49ers
Cardinals

Who's better at rushing (in terms of a per play success rate):
Buccaneers
Bills
Jags
Eagles
Cowboys

Plotting
```{r}
passing_rushing_teams = passing_success%>%
  inner_join(rushing_success, by = "team_abbr")

passing_rushing_plot = ggplot(passing_rushing_teams, aes(x = pass_success_per, y = rush_success_per)) +
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.07) +
  labs(
    title = "Team Offensive Success",
    subtitle = "2025 Season",
    x = "Passing Success Rate",
    y = "Rushing Success Rate")+
  dark_theme_minimal()+
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

passing_rushing_plot
```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/passing_rushing_plot.png",
  plot = passing_rushing_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```


##EPA
```{r}
Offensive_EPA = pbp%>%
  group_by(posteam)%>%
  summarize(Total_EPA_Generated_OFF= sum(epa),
            EPA_per_play_OFF= Total_EPA_Generated_OFF / n())%>%
  rename(team_abbr = posteam)%>%
  arrange(desc(EPA_per_play_OFF))

Defensive_EPA = pbp%>%
  group_by(defteam)%>%
  summarize(Total_EPA_Generated_DEF = sum(epa),
            EPA_per_play_DEF = Total_EPA_Generated_DEF / n())%>%
  rename(team_abbr = defteam)%>%
    arrange(EPA_per_play_DEF)
```


Plotting
```{r}
EPA_offense_defense = Offensive_EPA%>%
  inner_join(Defensive_EPA, by = "team_abbr")

EPA_offense_defense_plot = ggplot(EPA_offense_defense, 
                                  aes(x = EPA_per_play_OFF, y = EPA_per_play_DEF))+
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.07)+
  labs(
    title = "Offensive and Defensive EPA by Team",
    subtitle = "2025 Season",
    x = "Offensive EPA per play (higher is better)",
    y = "Defensive EPA per play (more negative is better)")+
  dark_theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_reverse()

EPA_offense_defense_plot
```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/EPA_offense_defense_plot.png",
  plot = EPA_offense_defense_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```


##QB EPA Through Week 2
```{r}
QB_EPA = pbp%>%
  filter(pass == 1)%>%
  group_by(posteam, passer_player_name)%>%
  summarize(Total_QB_EPA= sum(qb_epa),
            QB_EPA_per_play= Total_QB_EPA / n(), 
            snaps = n())%>%
  rename(team_abbr = posteam)%>%
  filter(!is.na(passer_player_name))%>%
  arrange(desc(QB_EPA_per_play))
```

Plotting

```{r}
QB_EPA_snaps = ggplot(QB_EPA, 
                                  aes(x = passer_player_name, y = QB_EPA_per_play))+
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.07)+
  geom_text_repel(aes(label = passer_player_name), 
                  box.padding = 0.5,
                  point.padding = 0.5,
                  nudge_y = 0.04,
                  size = 3, 
                  color = "white")+
  labs(
    title = "QB EPA and Passing Snap Count",
    subtitle = "2025 Season",
    x = "Player",
    y = "QB EPA per play (higher is better)")+
  dark_theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

QB_EPA_snaps
```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/QB_EPA_snaps.png",
  plot = QB_EPA_snaps,
  width = 10, 
  height = 7,
  dpi = 320)
```

##QBS
##Passing
Who is airing the ball out the most?
```{r}
airing = pbp%>%
  filter(play_type == "pass")%>%
  mutate(checkdown = ifelse(!is.na(air_yards) & air_yards < 5, 1, 0),
  checkdown = as.numeric(checkdown),
  deep_throw = ifelse(!is.na(air_yards) & air_yards > 25, 1, 0),
  deep_throw = as.numeric(deep_throw))%>%
  group_by(posteam, passer_player_name)%>%
  summarize(
    plays = n(),
    completions = sum(complete_pass, na.rm = TRUE),
    completion_percentage = mean(complete_pass, na.rm = TRUE),
    yards = sum(passing_yards, na.rm = TRUE),
    touchdowns = sum(pass_touchdown, na.rm = TRUE),
    interceptions = sum(interception, na.rm = TRUE),
    average_yards_gained = mean(yards_gained, na.rm = TRUE),
    average_yards_to_go = mean(ydstogo, na.rm = TRUE),
    ADOT = mean(air_yards, na.rm = TRUE),
    third_downs_converted = sum(third_down_converted, na.rm = TRUE),
    third_down_conversion_rate = mean(third_down_converted, na.rm = TRUE),
    epa_generated = sum(qb_epa, na.rm = TRUE),
    epa_generated_per_pass = mean(qb_epa, na.rm = TRUE),
    air_epa_generated = sum(air_epa, na.rm = TRUE),
    air_epa_generated_per_pass = mean(air_epa, na.rm = TRUE),
    comp_air_epa_generated = sum(comp_air_epa, na.rm = TRUE),
    comp_air_epa_generated_per_pass = mean(comp_air_epa, na.rm = TRUE),
    average_expected_pass_probability = mean(xpass, na.rm = TRUE),
    average_pass_rate_over_expected = mean(pass_oe, na.rm = TRUE),
    checkdowns = sum(checkdown),
    deep_throws = sum(deep_throw),
    checkdown_rate = (checkdowns / n()),
    deep_throw_rate = (deep_throws / n()))%>%
  ungroup()%>%
  filter(plays >= 20)%>% #Filter control for QB's
  rename(team_abbr = posteam)

```

Looking at QBs who are passing higher than expected in 2025
```{r}
passing_over_expected_plot = ggplot(airing, 
                                  aes(x = passer_player_name, y = average_pass_rate_over_expected))+
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.07)+
  geom_text_repel(aes(label = passer_player_name), 
                  box.padding = 0.5,
                  point.padding = 0.5,
                  nudge_y = 0.04,
                  size = 3, 
                  color = "white")+
  labs(
    title = "QB's by Average Pass Rate over Expected",
    subtitle = "2025 Season",
    x = "Player",
    y = "Pass Rate (over Expected)")+
  dark_theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

passing_over_expected_plot

```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/passing_over_expected_plot.png",
  plot = passing_over_expected_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```

Are you Passing ahead of the sticks?
```{r}
passing_ahead_of_sticks_plot = ggplot(airing, 
                                  aes(x = ADOT, y = average_yards_to_go))+
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.05)+
  geom_jitter(width = 0.20, height = 0.20)+
  geom_text_repel(aes(label = passer_player_name), 
                  box.padding = 0.5,
                  point.padding = 0.5,
                  nudge_y = 0.05,
                  size = 3, 
                  color = "white",
                  force = 5,
                  max.overlaps = 20)+
  labs(
    title = "Average Depth of Target and Average Yards to Go",
    subtitle = "QB's in the 2025 Season",
    x = "ADOT",
    y = "Yrds to Go")+
  dark_theme_minimal()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

passing_ahead_of_sticks_plot
```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/passing_ahead_of_sticks_plot.png",
  plot = passing_ahead_of_sticks_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```


Checkdown Rate and Deep Throw Rate
```{r}
checkdown_deep_throw_plot = ggplot(airing, 
  aes(x = checkdown_rate, y = deep_throw_rate))+
  geom_nfl_logos(aes(team_abbr = team_abbr), width = 0.055)+
  geom_text_repel(
    aes(label = passer_player_name),
    size = 2.8, 
    color = "white",
    box.padding = 0.2, 
    point.padding = 0.2, 
    force = 1.5,  
    max.overlaps = Inf,
    segment.color = "gray60",
    segment.size = 0.2)+
  labs(
    title = "Checkdown and Deep Throw Rates",
    subtitle = "QBs in the 2025 Season (min. 20 dropbacks)",
    x = "Checkdown Rate (Under 5 yards)",
    y = "Deep Throw Rate (25 yards or more)")+
  dark_theme_minimal()+
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title = element_text(size = 12))

checkdown_deep_throw_plot

```

```{r}
ggsave(
  filename = "G:/My Drive/Personal Projects/checkdown_deep_throw_plot.png",
  plot = checkdown_deep_throw_plot,
  width = 10, 
  height = 7,
  dpi = 320)
```




